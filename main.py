import requests
import telebot
from telebot import types
from flask import Flask, request
import re 
import os 
import sys
import json 

# ğŸš¨ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ§Ù„ Ù…Ù† Ù…Ù„Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ
from handlers.download import download_media_yt_dlp, load_links, save_links

# ===============================================
#              0. Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø«ÙˆØ§Ø¨Øª ÙˆØ§Ù„ØªÙ‡ÙŠØ¦Ø©
# ===============================================

# Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦ÙŠØ©
BOT_TOKEN = os.getenv("BOT_TOKEN") 
WEBHOOK_URL_BASE = os.getenv("WEBHOOK_URL") 
WEBHOOK_URL_PATH = "/{}".format(BOT_TOKEN) 

DEVELOPER_USER_ID = "1315011160"
CHANNEL_USERNAME = "@SuPeRx1" # ÙŠÙÙØ¶Ù„ ÙˆØ¶Ø¹Ù‡ ÙƒÙ…ØªØºÙŠØ± Ø¨ÙŠØ¦ÙŠ Ø£ÙŠØ¶Ø§Ù‹

# Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
try:
    bot = telebot.TeleBot(BOT_TOKEN)
    app = Flask(name) 
except Exception as e:
    print(f"âŒ ÙØ´Ù„ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙˆØª/Flask. Ø§Ù„Ø®Ø·Ø£: {e}")

# ===============================================
#              1. Ù†Ù‚Ø§Ø· ÙˆØµÙˆÙ„ Webhook
# ===============================================

@app.route(WEBHOOK_URL_PATH, methods=['POST'])
def webhook():
    """Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªÙŠ ÙŠØ³ØªÙ‚Ø¨Ù„ Ù…Ù†Ù‡Ø§ Ø§Ù„Ø¨ÙˆØª ØªØ­Ø¯ÙŠØ«Ø§Øª ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…."""
    if request.headers.get('content-type') == 'application/json':
        try:
            json_string = request.get_data().decode('utf-8')
            update = telebot.types.Update.de_json(json_string)
            bot.process_new_updates([update])
        except Exception as e:
            print(f"âŒ Ø®Ø·Ø£ Ø­Ø±Ø¬ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Webhook: {e}")
        return '', 200 
    else:
        return 'Error', 403

# ===============================================
#              2. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©)
# ===============================================

@bot.message_handler(commands=["start"])
def send_welcome(message):
    first_name = message.from_user.first_name if message.from_user else "ØµØ¯ÙŠÙ‚Ù†Ø§"
    markup = types.InlineKeyboardMarkup(row_width=2)
    tt_btn = types.InlineKeyboardButton("ØªØ­Ù…ÙŠÙ„ ØªÙŠÙƒ ØªÙˆÙƒ ğŸ¶", callback_data="download_tiktok")
    ig_btn = types.InlineKeyboardButton("ØªØ­Ù…ÙŠÙ„ Ø¥Ù†Ø³ØªØ¬Ø±Ø§Ù… ğŸ“¸", callback_data="download_instagram")
    yt_btn = types.InlineKeyboardButton("ØªØ­Ù…ÙŠÙ„ ÙŠÙˆØªÙŠÙˆØ¨ â–¶ï¸", callback_data="download_youtube")
    dev_btn = types.InlineKeyboardButton("Ø§Ù„Ù…Ø·ÙˆØ± ğŸ‘¨â€ğŸ’»", url="https://t.me/yourusername") 
    markup.add(tt_btn, ig_btn, yt_btn, dev_btn)
    bot.send_message(
        message.chat.id,
        f"""<b>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ {first_name}!</b> ğŸ‘‹
        Ø£Ù†Ø§ Ø¨ÙˆØª Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø§Ù…Ù„. Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù†Ù‡Ø§:
        * Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ø¯Ù†Ø§Ù‡ ÙˆØ£Ø±Ø³Ù„ <b>Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙˆØ±Ø§Ù‹</b>.
        """,
        parse_mode='HTML', 
        reply_markup=markup
    )

@bot.callback_query_handler(func=lambda call: call.data.startswith('download_'))
def handle_download_choice(call):
    platform_key = call.data.split('_')[1]
    platforms = {'tiktok': 'ØªÙŠÙƒ ØªÙˆÙƒ', 'instagram': 'Ø¥Ù†Ø³ØªØ¬Ø±Ø§Ù…', 'youtube': 'ÙŠÙˆØªÙŠÙˆØ¨'}
    platform = platforms.get(platform_key, 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ')
    
    bot.edit_message_text(
        chat_id=call.message.chat.id,
        message_id=call.message.message_id,
        text=f"""<b>ğŸš€ Ø£Ø±Ø³Ù„ Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ {platform} Ø§Ù„Ø¢Ù†!</b>""",
        parse_mode='HTML' 
    )
    call.message.platform_key = platform_key 
    bot.register_next_step_handler(call.message, process_user_link)
    
# ===============================================
#              3. Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø§Ù„Ù…ÙˆØ­Ø¯Ø© Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
# ===============================================

@bot.message_handler(func=lambda m: True)
def process_user_link(message):
    user_url = message.text
    loading_msg = None
    platform_key = getattr(message, 'platform_key', None) 
    
    # 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
    if user_url.startswith('/'):
        bot.send_message(message.chat.id, "âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©. Ø§Ø¶ØºØ· /start.", parse_mode='HTML')
        return send_welcome(message)

    # 2. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù†ØµØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø·
    if not platform_key:
        if re.match(r'https?://(?:www\.)?(?:tiktok\.com|vt\.tiktok\.com|vm\.tiktok\.com)/', user_url):
